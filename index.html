<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <title>ImJoy Slides</title>

  <link rel="stylesheet" href="assets/reveal.js/reset.css" />
  <link rel="stylesheet" href="assets/reveal.js/reveal.css" />


  <!-- Theme used for syntax highlighted code -->
  <link rel="stylesheet" href="assets/reveal.js/plugin/highlight/monokai.css" id="highlight-theme" />
  <style>
    .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5, .reveal h6 {
      text-transform: none!important;
    }
    .reveal iframe {
        max-width: 100%!important;
        max-height: 100%!important;
    }
    .button {
      cursor: pointer;
      background-color: #3b60f4; /* Green */
      border-radius: 3px;
      color: white;
      padding: 10px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
    }
  </style>
</head>

<body>
  <div class="reveal" style="z-index: 0">
    <div class="slides markdown-slide-content">
      <section data-markdown data-separator="-----" data-separator-vertical="---">
        <textarea data-template>
            # ImJoy
        </textarea>
      </section>
    </div>
  </div>
  <div id="window-container" style="z-index: 100"></div>
  <div id="menu-container" style="z-index: 200"></div>
  <script src="assets/reveal.js/reveal.js"></script>
  <script src="assets/reveal.js/plugin/notes/notes.js"></script>
  <script src="assets/reveal.js/plugin/markdown/markdown.js"></script>
  <script src="assets/reveal.js/plugin/highlight/highlight.js"></script>
  <script src="assets/reveal.js/plugin/zoom/zoom.js"></script>
  <script src="assets/reveal.js/plugin/math/math.js"></script>
  <script src="assets/utils.js"></script>
  <script src="assets/fullscreen.js"></script>
  <script src="https://lib.imjoy.io/imjoy-loader.js"></script>
  <script>
    let currentSlidesContent = null
    let defaultTheme = 'black'
    let defaultTransition = 'fade'
    let customEventListeners = {}
    const mainElem = document.querySelector('.reveal');
    // add event listener hook to keep track of the event added later
    let oldRevealAddEventListener = mainElem.addEventListener
    mainElem.addEventListener = (event, handler) => {
      if(!customEventListeners[event])
        customEventListeners[event] = [handler]
      else
        customEventListeners[event].push(handler)
      oldRevealAddEventListener.apply(mainElem, [event, handler])
    }

    function resetCustomEventListeners(){
      for(let evt in customEventListeners){
        for(let handler of customEventListeners[evt]){
          Reveal.removeEventListener(evt, handler)
        }
      }
      customEventListeners = {}
    }

    async function startRevealJS(){
      const slides = getUrlParameter('slides') || 'https://raw.githubusercontent.com/imjoy-team/imjoy-slides/master/slides/imjoy-slides-introduction.md'
      defaultTheme = getUrlParameter('theme') || defaultTheme
      defaultTransition = getUrlParameter('transition') || defaultTransition
      const edit = getUrlParameter('edit')
      
      if(slides){
        const url = await githubUrlRaw(slides, ".md") || slides;
        const response = await fetch(url)
        currentSlidesContent = await response.text()
      }
      await initializeRevealJS(currentSlidesContent, defaultTheme, defaultTransition);

      const baseUrl = location.protocol+'//'+location.hostname+(location.port ? ':'+location.port: '');
      await app.imjoy.pm
        .reloadPluginRecursively({uri: baseUrl + "/assets/SlideEditor.imjoy.html"});
      app.addMenuItem({
        label: "✏️ Edit Slides",
        async callback() {
          const p = await api.getPlugin('Slide Editor')
          const lastContent = window.localStorage.getItem('config_Slide Editor_imjoy-slides-content')
          if(lastContent && lastContent != currentSlidesContent){
            if(await api.confirm("Would you like to restore the slides you edited last time?")){
              await p.run({data: {code: lastContent}})
              return
            }
          }
          await p.run({data: {code: currentSlidesContent}})
        },
      });
      if(edit){
        // show editor
        const p = await api.getPlugin('Slide Editor')
        await p.run({data: {code: currentSlidesContent}})
      }
      if (screenfull.enabled) {
        app.addMenuItem({
          label: " ⤡ Full Screen [F]",
          async callback() {     
              screenfull.toggle(document.documentElement);
          }
        })
      }
    }

    async function initializeRevealJS(content, theme, transition) {
      resetCustomEventListeners();

      let currentSlide = null
      try{
        const s = Reveal.getCurrentSlide();
        // save current slide position
        currentSlide = Reveal.getIndices(s);
      }
      catch(e){
      }
      const elm = document.querySelector('.markdown-slide-content')
      const container = elm.parentElement;
      for (var c = 0; c < container.childNodes.length; c++) {
          if (container.childNodes[c] !== elm) {
            container.removeChild(container.childNodes[c--]);
          }
      }
      currentSlidesContent = content

      if (content) {
        try {
          content = runScripts(content)
        } catch (e) {
          console.error(e)
          api.showMessage(`Failed to execute script: ${e}`)
        }
        elm.innerHTML = `<section data-markdown data-separator="-----" data-separator-vertical="---"><textarea data-template>${content}</textarea></section>`
      }

      try {
        if (theme) {
          if (theme.startsWith('http')) {
            await addCss(theme)
          } else {
            await addCss(`assets/reveal.js/theme/${theme}.css`)
          }
        }
      } catch (e) {
        alert('Failed to load theme: ' + theme)
      }
      if(typeof Reveal.removeEventListeners === 'function') Reveal.removeEventListeners();
      // More info about initialization & config:
      // - https://revealjs.com/initialization/
      // - https://revealjs.com/config/
      Reveal.initialize({
        width: "100%",
        height: "100%",
        hash: true,
        // slideNumber: true,
        transition: transition || 'fade', // none/fade/slide/convex/concave/zoom
        math: {
          mathjax: 'https://cdn.jsdelivr.net/gh/mathjax/mathjax@2.7.8/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          // pass other options into `MathJax.Hub.Config()`
          TeX: { Macros: { RR: "{\\bf R}" } }
        },
        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [RevealMarkdown, RevealMath, RevealHighlight, RevealNotes, RevealZoom],
      });
      
      try {
        Reveal.layout();
        if(currentSlide) {
          // we need this trick to trigger the slide change event
          Reveal.slide(0, 0, 0);
          setTimeout(()=>{
            // restore slide position
            Reveal.slide(currentSlide.h, currentSlide.v, currentSlide.f);
          },0)
        }
        else{
          Reveal.slide(0, 0, 0);
        }
        Reveal.sync();
      } catch (ex) {
        console.error(ex)
      }

      Reveal.on( 'slidechanged', event => {
        // clean up embedded window
        for(let w of app.allWindows){
          if(!w.dialog && !w.window_id.startsWith('plugin_window_')){
            w.close()
          }
        }
      });

      makeSlideScrollable();
    }

    loadImJoyBasicApp({
      process_url_query: true,
      show_window_title: false,
      show_progress_bar: true,
      show_empty_window: true,
      menu_style: {
        position: "absolute",
        right: 0,
        top: "4px"
      },
      window_style: {
        width: '100%',
        height: '100%'
      },
      main_container: null,
      menu_container: "menu-container",
      window_manager_container: "window-container",
      imjoy_api: {} // override some imjoy API functions here
    }).then(async app => {
      // get the api object from the root plugin
      const api = app.imjoy.api;
      app.$on('window-size-pos-changing', (changing)=>{
        const iframes = document.querySelectorAll('.reveal iframe')
        for(let iframe of iframes){
          iframe.style.pointerEvents = changing ? 'none': 'all';
        }
      })
      // if you want to let users to load new plugins, add a menu item
      app.addMenuItem({
        label: "➕ Load Plugin",
        callback() {
          const uri = prompt(
            `Please type a ImJoy plugin URL`,
            "https://github.com/imjoy-team/imjoy-plugins/blob/master/repository/ImageAnnotator.imjoy.html"
          );
          if (uri) app.loadPlugin(uri);
        },
      });

      await api.registerService({
        name: 'ImJoy Slides',
        type: '#imjoy-slides',
        async show(content, config ){
          const { theme, transition } = config || {}
          await initializeRevealJS(content, theme || defaultTheme, transition || defaultTransition)
        }
      })
      // expose global variables
      window.api = api;
      window.imjoy = app.imjoy
      window.app = app;
      await startRevealJS();
      app.imjoy.pm
          .reloadPluginRecursively({
            uri:
              "https://imjoy-team.github.io/jupyter-engine-manager/Jupyter-Engine-Manager.imjoy.html"
          })
          .then(enginePlugin => {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const engine = urlParams.get("engine");
            const spec = urlParams.get("spec");
            if (engine) {
              enginePlugin.api
                .createEngine({
                  name: "MyCustomEngine",
                  nbUrl: engine,
                  url: engine.split("?")[0]
                })
                .then(() => {
                  console.log("Jupyter Engine connected!");
                })
                .catch(e => {
                  console.error("Failed to connect to Jupyter Engine", e);
                });
            } else {
              enginePlugin.api
                .createEngine({
                  name: "MyBinder Engine",
                  url: "https://mybinder.org",
                  spec: spec || "oeway/imjoy-binder-image/master"
                })
                .then(() => {
                  console.log("Binder Engine connected!");
                })
                .catch(e => {
                  console.error("Failed to connect to MyBinder Engine", e);
                });
            }
          });
      app.addMenuItem({
        label: "ℹ️ Github",
        callback(){
          window.open("https://github.com/imjoy-team/imjoy-slides#readme")
        }
      })
    }).catch(e => {
      console.error(e)
      startRevealJS(slides, theme);
    })
  </script>
</body>

</html>
